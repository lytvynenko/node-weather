<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-weather/app/services.js</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../prettify.css">
    <link rel="stylesheet" href="../../base.css">
    <style type='text/css'>
        div.coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class="header high">
    <h1>Code coverage report for <span class="entity">node-weather/app/services.js</span></h1>
    <h2>
        Statements: <span class="metric">98.33% <small>(59 / 60)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Branches: <span class="metric">84.38% <small>(27 / 32)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Functions: <span class="metric">100% <small>(5 / 5)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Lines: <span class="metric">98.31% <small>(58 / 59)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../index.html">All files</a> &#187; <a href="index.html">node-weather/app/</a> &#187; services.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147</td><td class="line-coverage"><span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-yes">5</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">4</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">3</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var request = require('request');
var moment = require('moment');
var utils = require('./utils');
&nbsp;
/**
 * location service
 * @param  {String}  location  - geographical entity name
 *
 * Performs geocoding via Google Maps Geocoding API endoint
 * returns "coords" object with "lat" (latitude) and "lng" (longitude) properties.
 */
var location = function(location, callback) {
&nbsp;
	request('http://maps.googleapis.com/maps/api/geocode/json?address='+location,function(err,res,data){
		var result = {};
		<span class="missing-if-branch" title="else path not taken" >E</span>if (!err &amp;&amp; res.statusCode== 200){
			data = JSON.parse(data);
			if (data.results.length == 0) return callback(true,"No location found");
			for (var i = data.results.length - 1; i &gt; -1; i--) {
				<span class="missing-if-branch" title="else path not taken" >E</span>if (data.results[i].geometry &amp;&amp; data.results[i].geometry.location) {
					var coords = {};
					coords.lat = data.results[i].geometry.location.lat;
					coords.lng = data.results[i].geometry.location.lng;
					result.error = false;
					result.payload = coords;
					return callback(result.error,result.payload);
				}
			}
		}
		else
		{
<span class="cstat-no" title="statement not covered" >			return callback(true,"Google Maps Geolocation API error: statusCode:"+res.statusCode);</span>
		}	
	})
}
&nbsp;
&nbsp;
/**
 * forecast service
 * @param  {String}  forecastURL  -Forecast.io endoint URL
 * @param  {Float}  lat  - GPS latitude
 * @param  {Float}  lng  - GPS longitude
 * @param  {Int}  datetime  - datetime UNIX timestamp
 * @param  {Object}  options  - additional request options 
						 	units=[setting]: Return the API response in units other than the default Imperial units. In particular, the following settings are possible:
							us: The default, as outlined above.
							si: Returns results in SI units.
							ca: Identical to si, except that windSpeed is in kilometers per hour.
							uk: Identical to si, except that windSpeed is in miles per hour, as in the US. (This option is provided because adoption of SI in the UK has been inconsistent.)
							auto: Selects the relevant units automatically, based on geographic location.
							exclude=[blocks]: Exclude some number of data blocks from the API response. This is useful for reducing latency and saving cache space. [blocks] should be a comma-delimeted list (without spaces) of any of the following: currently, minutely, hourly, daily, alerts, flags. (Crafting a request with all of the above blocks excluded is exceedingly silly and not recommended.)
							extend=hourly: When present on a forecast request, return hourly data for the next seven days, rather than the next two. (This option is ignored on time machine requests. When using this option, we strongly recommend ensuring that your HTTP client supports compression.)
							lang=[language]: Return text summaries in the desired language. (Please be advised that units in the summary will be set according to the units option, above, so be sure to set both options as needed.) [language] may be bs (Bosnian), de (German), en (English, which is the default), es (Spanish), fr (French), it (Italian), nl (Dutch), pl (Polish), pt (Portuguese), ru (Russian), tet (Tetum), or x-pig-latin (Igpay Atinlay). (If a different language is desired, please consider contributing to our API translation module on Github.)
 *
 * Performs geocoding via Google Maps Geocoding API endoint
 * returns "coords" object with "lat" (latitude) and "lng" (longitude) properties.
 */
&nbsp;
var forecast = function(forecastURL,lat,lng,datetime,options,callback) {
&nbsp;
	var result = {};
&nbsp;
	// options are parsing and validation by "utils.forecastParams" method. 
	var optionsQuery = utils.forecastParams(options) || <span class="branch-1 cbranch-no" title="branch not covered" >'';</span>
&nbsp;
	//if datetime is not provided we'll use current
	datetime = datetime || Math.round(new Date().getTime()/1000);  
&nbsp;
	//forming forecast.io request URL
	var forecastURL = forecastURL+lat+','+lng+(datetime ? ','+datetime:<span class="branch-1 cbranch-no" title="branch not covered" >'')</span>+ optionsQuery; 
&nbsp;
	request(forecastURL,function(err,res,data){
		if (!err &amp;&amp; res.statusCode== 200){
			data = JSON.parse(data);
			result.error = false;
			result.payload = data;
		}
		else
		{
			result.error = true;
			result.payload = "Forecast API request error";
		}
&nbsp;
		return callback(result.error,result.payload);
	})
}
&nbsp;
/**
 * Day service
 * @param  {String}  strDay  - weekday (i.e. monday,tuesday..) or "today" or "04.30.2015"  
 *
 * The weekday is always in the future  
 * If the requested day is the same as the current day, the weather returned should be for one week from the current day.).
 * 
 * returns datetime UNIX timestamp 
 */
var day = function(strDay,callback){
			var result = {};
			var pattern = new RegExp(/^([^0-9]*)$/); 					// Regular expression - not any digits here!
			if (pattern.test(strDay)) {
				var today = new Date();
				if (strDay == 'today') {
					result.error = false;
					result.payload = today.getTime();
				}
				else
				{
					var arrDays = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
					if (arrDays.indexOf(strDay)==-1) { 
						result.error = true;
						result.payload = "Invalid date"; 
					}
					else
					{	
						var dayDayOfWeek = arrDays.indexOf(strDay); 	// day of week for requested date
						var todayDay = new Date().getDay(); 			// today's day of week
						if (todayDay==dayDayOfWeek) { 
							var dayAsString = moment().add(7,'days') 	// just add 7 days to get next week's day	
						}
						else
						{
							var dayAsString = todayDay&gt;dayDayOfWeek ? moment().day(dayDayOfWeek).add(7,'days') : <span class="branch-1 cbranch-no" title="branch not covered" >moment().day(dayDayOfWeek);</span>
						}
						result.error = false;
						result.payload = new Date(dayAsString.toString()).getTime();
					}
				}
			}
			else
			{
				if (moment(strDay).toString()=='Invalid date') {
					result.error = true;
					result.payload = "Invalid date"; 
				}
				else
				{
					result.error = false;
					result.payload = new Date(moment(strDay)).getTime();
				}
			}
		return callback(result.error,result.payload);
	}
&nbsp;
module.exports.location = location;
module.exports.forecast = forecast;
module.exports.day = day;
&nbsp;</pre></td></tr>
</table></pre>

</div>
<div class="footer">
    <div class="meta">Generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Fri Apr 17 2015 08:22:53 GMT+1000 (AEST)</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
